<h1>API extension for Polarion ALM</h1>

<p>This Polarion extension provides additional functionality which is not implemented in standard Polarion API for some reason.</p>

<h2>Custom field for project</h2>

<p>Polarion project does not support setting custom fields out of the box. This API extension can be used to solve this problem.</p>
<p>This API can be called using REST API and in Velocity Context.</p>

<h3>REST API</h3>

<p>Get version:</p>
<pre>
    <code data-language="bash">
<span class="cm-builtin">curl</span> <span class="cm-attribute">--location</span> <span class="cm-string">'https://&lt;HOST&gt;:&lt;PORT&gt;/polarion/api-extender/rest/api/version'</span> \
<span class="cm-attribute">    --header</span> <span class="cm-string">'Authorization: Bearer &lt;TOKEN_GOES_HERE&gt;'</span>
    </code>
</pre>

<p>Response example:</p>
<pre>
    <code data-language="json">
{
  <span class="cm-string cm-property">"bundleName"</span>:<span class="cm-string">"API Extension for Polarion ALM"</span>,
  <span class="cm-string cm-property">"bundleVendor"</span>:<span class="cm-string">"SBB AG"</span>,
  <span class="cm-string cm-property">"automaticModuleName"</span>:<span class="cm-string">"ch.sbb.polarion.extension.api_extender"</span>,
  <span class="cm-string cm-property">"bundleVersion"</span>:<span class="cm-string">"1.0.0"</span>,
  <span class="cm-string cm-property">"bundleBuildTimestamp"</span>:<span class="cm-string">"2023-06-27 12:43"</span>,
  <span class="cm-string cm-property">"bundleBuildTimestampDigitsOnly"</span>:<span class="cm-string">"202306271243"</span>
}
    </code>
</pre>

<p>Get custom field value:</p>
<pre>
    <code data-language="bash">
<span class="cm-builtin">curl</span> <span class="cm-attribute">--location</span> <span class="cm-string">'https://&lt;HOST&gt;:&lt;PORT&gt;/polarion/api-extender/rest/api/projects/&lt;PROJECT_ID&gt;/keys/&lt;CUSTOM_FIELD&gt;'</span> \
<span class="cm-attribute">    --header</span> <span class="cm-string">'Authorization: Bearer &lt;TOKEN_GOES_HERE&gt;'</span>
    </code>
</pre>

<p>Get global record value:</p>
<pre>
    <code data-language="bash">
<span class="cm-builtin">curl</span> <span class="cm-attribute">--location</span> <span class="cm-string">'https://&lt;HOST&gt;:&lt;PORT&gt;/polarion/api-extender/rest/api/records/&lt;RECORD&gt;'</span> \
<span class="cm-attribute">    --header</span> <span class="cm-string">'Authorization: Bearer &lt;TOKEN_GOES_HERE&gt;'</span>
    </code>
</pre>

<p>Response example:</p>
<pre>
    <code data-language="json">
{
  <span class="cm-string cm-property">"value"</span>: <span class="cm-string">"custom_value"</span>
}
    </code>
</pre>

<p>Set custom field value:</p>
<pre>
    <code data-language="bash">
<span class="cm-builtin">curl</span> <span class="cm-attribute">--location</span> <span class="cm-string">'https://&lt;HOST&gt;:&lt;PORT&gt;/polarion/api-extender/rest/api/projects/&lt;PROJECT_ID&gt;/keys/&lt;CUSTOM_FIELD&gt;'</span> \
<span class="cm-attribute">    --header</span> <span class="cm-string">'Content-Type: application/json'</span> \
<span class="cm-attribute">    --header</span> <span class="cm-string">'Authorization: Bearer &lt;TOKEN_GOES_HERE&gt;'</span> \
<span class="cm-attribute">    --data</span> <span class="cm-string">'{</span>
<span class="cm-string">          "value": "&lt;VALUE&gt;"</span>
<span class="cm-string">        }'</span>
    </code>
</pre>

<p>Set global record value:</p>
<pre>
    <code data-language="bash">
<span class="cm-builtin">curl</span> <span class="cm-attribute">--location</span> <span class="cm-string">'https://&lt;HOST&gt;:&lt;PORT&gt;/polarion/api-extender/rest/api/records/&lt;RECORD&gt;'</span> \
<span class="cm-attribute">    --header</span> <span class="cm-string">'Content-Type: application/json'</span> \
<span class="cm-attribute">    --header</span> <span class="cm-string">'Authorization: Bearer &lt;TOKEN_GOES_HERE&gt;'</span> \
<span class="cm-attribute">    --data</span> <span class="cm-string">'{</span>
<span class="cm-string">          "value": "&lt;VALUE&gt;"</span>
<span class="cm-string">        }'</span>
    </code>
</pre>

<h3>Live Report Page</h3>

<p>Get version:</p>
<pre>
    <code data-language="velocity">
<span class="cm-keyword">#set</span> (<span class="cm-builtin">$version</span> <span class="cm-operator">=</span> <span class="cm-builtin">$customFieldsProject.getVersion</span>())
<span class="cm-keyword">#if</span> (<span class="cm-builtin">$version</span>)
    API Extender version <span class="cm-operator">=</span> <span class="cm-builtin">$version</span>
<span class="cm-keyword">#end</span>
    </code>
</pre>
<p>or</p>
<pre>
    <code data-language="velocity">
<span class="cm-keyword">#set</span> (<span class="cm-builtin">$version</span> <span class="cm-operator">=</span> <span class="cm-builtin">$globalRecords.getVersion</span>())
<span class="cm-keyword">#if</span> (<span class="cm-builtin">$version</span>)
    API Extender version <span class="cm-operator">=</span> <span class="cm-builtin">$version</span>
<span class="cm-keyword">#end</span>
    </code>
</pre>

<p>Get custom field value:</p>
<pre>
    <code data-language="velocity">
<span class="cm-keyword">#set</span> (<span class="cm-builtin">$field</span> <span class="cm-operator">=</span> <span class="cm-builtin">$customFieldsProject.getCustomField</span>(<span class="cm-string">'elibrary'</span>, <span class="cm-string">'custom_field'</span>))
<span class="cm-keyword">#if</span> (<span class="cm-builtin">$field</span>)
    <span class="cm-builtin">$field.getValue</span>()
    <span class="cm-operator">&lt;</span>br<span class="cm-operator">&gt;</span>
<span class="cm-keyword">#end</span>
    </code>
</pre>

<p>Get global record value:</p>
<pre>
    <code data-language="velocity">
<span class="cm-keyword">#set</span> (<span class="cm-builtin">$field</span> <span class="cm-operator">=</span> <span class="cm-builtin">$globalRecords.getRecord</span>(<span class="cm-string">'record_name'</span>))
<span class="cm-keyword">#if</span> (<span class="cm-builtin">$field</span>)
    <span class="cm-builtin">$field.getValue</span>()
    <span class="cm-operator">&lt;</span>br<span class="cm-operator">&gt;</span>
<span class="cm-keyword">#end</span>
    </code>
</pre>

<p>Due to Polarion limitations we are not able to save custom fields in Live Report Page using Velocity, but we can use JavaScript for this.</p>

<p>Set custom field value:</p>
<pre>
    <code data-language="html">
<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">input</span> <span class="cm-attribute">id</span>=<span class="cm-string">'cfp_project'</span> <span class="cm-attribute">type</span>=<span class="cm-string">'text'</span> <span class="cm-attribute">value</span>=<span class="cm-string">'elibrary'</span> <span class="cm-attribute">name</span>=<span class="cm-string">'project'</span><span class="cm-tag cm-bracket">/&gt;</span>
<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">input</span> <span class="cm-attribute">id</span>=<span class="cm-string">'cfp_key'</span> <span class="cm-attribute">type</span>=<span class="cm-string">'text'</span> <span class="cm-attribute">value</span>=<span class="cm-string">'custom_field'</span> <span class="cm-attribute">name</span>=<span class="cm-string">'key'</span><span class="cm-tag cm-bracket">/&gt;</span>
<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">input</span> <span class="cm-attribute">id</span>=<span class="cm-string">'cfp_value'</span> <span class="cm-attribute">type</span>=<span class="cm-string">'text'</span> <span class="cm-attribute">value</span>=<span class="cm-string">'custom_value'</span> <span class="cm-attribute">name</span>=<span class="cm-string">'value'</span><span class="cm-tag cm-bracket">/&gt;</span>

<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">script</span><span class="cm-tag cm-bracket">&gt;</span>
    <span class="cm-keyword">function</span> <span class="cm-def">save_project_custom_field</span>() {
        <span class="cm-keyword">const</span> <span class="cm-def">project</span> <span class="cm-operator">=</span> <span class="cm-variable">document</span>.<span class="cm-property">getElementById</span>(<span class="cm-string">'cfp_project'</span>).<span
            class="cm-property">value</span>;
        <span class="cm-keyword">const</span> <span class="cm-def">key</span> <span class="cm-operator">=</span> <span class="cm-variable">document</span>.<span class="cm-property">getElementById</span>(<span
            class="cm-string">'cfp_key'</span>).<span class="cm-property">value</span>;
        <span class="cm-keyword">const</span> <span class="cm-def">value</span> <span class="cm-operator">=</span> <span class="cm-variable">document</span>.<span class="cm-property">getElementById</span>(<span
            class="cm-string">'cfp_value'</span>).<span class="cm-property">value</span>;
        <span class="cm-keyword">const</span> <span class="cm-def">requestBody</span> <span class="cm-operator">=</span> (<span class="cm-variable-2">value</span> <span class="cm-operator">===</span> <span class="cm-atom">null</span> <span
            class="cm-operator">||</span> <span class="cm-variable-2">value</span> <span class="cm-operator">===</span> <span class="cm-string">""</span>) <span class="cm-operator">?</span> <span class="cm-string">""</span> : <span
            class="cm-variable">JSON</span>.<span class="cm-property">stringify</span>({<span class="cm-string cm-property">'value'</span>: <span class="cm-variable-2">value</span>});

        <span class="cm-variable">fetch</span>(<span class="cm-string">'/polarion/api-extender/rest/internal/projects/'</span> <span class="cm-operator">+</span> <span class="cm-variable-2">project</span> <span class="cm-operator">+</span> <span
            class="cm-string">'/keys/'</span> <span class="cm-operator">+</span> <span class="cm-variable-2">key</span>, {
            <span class="cm-property">method</span>: <span class="cm-string">'POST'</span>,
            <span class="cm-property">headers</span>: {
                <span class="cm-string cm-property">'Accept'</span>: <span class="cm-string">'application/json'</span>,
                <span class="cm-string cm-property">'Content-Type'</span>: <span class="cm-string">'application/json'</span>
            },
            <span class="cm-property">body</span>: <span class="cm-variable-2">requestBody</span>
        })
        .<span class="cm-property">then</span>(<span class="cm-def">response</span> <span class="cm-operator">=&gt;</span> {
            <span class="cm-keyword">if</span> (<span class="cm-variable-2">response</span>.<span class="cm-property">ok</span>) {
                <span class="cm-keyword">return</span> <span class="cm-string">"Saved!"</span>
            } <span class="cm-keyword">else</span> {
                <span class="cm-keyword">return</span> <span class="cm-variable-2">response</span>.<span class="cm-property">text</span>()
            }
        })
        .<span class="cm-property">then</span>(<span class="cm-def">text</span> <span class="cm-operator">=&gt;</span> {
             <span class="cm-variable">alert</span>(<span class="cm-variable-2">text</span>)
        });
    }
<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">script</span><span class="cm-tag cm-bracket">&gt;</span>

<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">button</span> <span class="cm-attribute">onclick</span>=<span class="cm-string">'save_project_custom_field()'</span><span class="cm-tag cm-bracket">&gt;</span>Save<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">button</span><span class="cm-tag cm-bracket">&gt;</span>
    </code>
</pre>

<p>Set global record value:</p>
<pre>
    <code data-language="html">
<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">input</span> <span class="cm-attribute">id</span>=<span class="cm-string">'record_key'</span> <span class="cm-attribute">type</span>=<span class="cm-string">'text'</span> <span class="cm-attribute">value</span>=<span class="cm-string">'record_name'</span> <span class="cm-attribute">name</span>=<span class="cm-string">'record_name'</span><span class="cm-tag cm-bracket">/&gt;</span>
<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">input</span> <span class="cm-attribute">id</span>=<span class="cm-string">'record_value'</span> <span class="cm-attribute">type</span>=<span class="cm-string">'text'</span> <span class="cm-attribute">value</span>=<span class="cm-string">'record_value'</span> <span class="cm-attribute">name</span>=<span class="cm-string">'record_value'</span><span class="cm-tag cm-bracket">/&gt;</span>

<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">script</span><span class="cm-tag cm-bracket">&gt;</span>
    <span class="cm-keyword">function</span> <span class="cm-def">save_record</span>() {
        <span class="cm-keyword">const</span> <span class="cm-def">key</span> <span class="cm-operator">=</span> <span class="cm-variable">document</span>.<span class="cm-property">getElementById</span>(<span
            class="cm-string">'record_key'</span>).<span class="cm-property">value</span>;
        <span class="cm-keyword">const</span> <span class="cm-def">value</span> <span class="cm-operator">=</span> <span class="cm-variable">document</span>.<span class="cm-property">getElementById</span>(<span class="cm-string">'record_value'</span>).<span
            class="cm-property">value</span>;
        <span class="cm-keyword">const</span> <span class="cm-def">requestBody</span> <span class="cm-operator">=</span> (<span class="cm-variable-2">value</span> <span class="cm-operator">===</span> <span class="cm-atom">null</span> <span
            class="cm-operator">||</span> <span class="cm-variable-2">value</span> <span class="cm-operator">===</span> <span class="cm-string">""</span>) <span class="cm-operator">?</span> <span class="cm-string">""</span> : <span
            class="cm-variable">JSON</span>.<span class="cm-property">stringify</span>({<span class="cm-string cm-property">'value'</span>: <span class="cm-variable-2">value</span>});

        <span class="cm-variable">fetch</span>(<span class="cm-string">'/polarion/api-extender/rest/internal/records/'</span> <span class="cm-operator">+</span> <span class="cm-variable-2">key</span>, {
            <span class="cm-property">method</span>: <span class="cm-string">'POST'</span>,
            <span class="cm-property">headers</span>: {
                <span class="cm-string cm-property">'Accept'</span>: <span class="cm-string">'application/json'</span>,
                <span class="cm-string cm-property">'Content-Type'</span>: <span class="cm-string">'application/json'</span>
            },
            <span class="cm-property">body</span>: <span class="cm-variable-2">requestBody</span>
        })
            .<span class="cm-property">then</span>(<span class="cm-def">response</span> <span class="cm-operator">=&gt;</span> {
                <span class="cm-keyword">if</span> (<span class="cm-variable-2">response</span>.<span class="cm-property">ok</span>) {
                    <span class="cm-keyword">return</span> <span class="cm-string">"Saved!"</span>
                } <span class="cm-keyword">else</span> {
                    <span class="cm-keyword">return</span> <span class="cm-variable-2">response</span>.<span class="cm-property">text</span>()
                }
            })
            .<span class="cm-property">then</span>(<span class="cm-def">text</span> <span class="cm-operator">=&gt;</span> {
                <span class="cm-variable">alert</span>(<span class="cm-variable-2">text</span>)
            });
    }
<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">script</span><span class="cm-tag cm-bracket">&gt;</span>

<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">button</span> <span class="cm-attribute">onclick</span>=<span class="cm-string">'save_record()'</span><span class="cm-tag cm-bracket">&gt;</span>Save<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">button</span><span class="cm-tag cm-bracket">&gt;</span>
    </code>
</pre>
<p>Note that internal API in URL should be used.</p>

<h3>Classic Wiki Page</h3>

<p>Get custom field value:</p>
<pre>
    <code data-language="velocity">
<span class="cm-keyword">#set</span>(<span class="cm-builtin">$projects</span> <span class="cm-operator">=</span> <span class="cm-builtin">$projectService.searchProjects</span>(<span class="cm-string">""</span>,<span class="cm-string">"id"</span>))

<span class="cm-keyword">#foreach</span>(<span class="cm-builtin">$project</span> in <span class="cm-builtin">$projects</span>)
    <span class="cm-keyword">#set</span>(<span class="cm-builtin">$projectId</span> <span class="cm-operator">=</span> <span class="cm-builtin">$project.id</span>)
    <span class="cm-keyword">#set</span>(<span class="cm-builtin">$field</span> <span class="cm-operator">=</span> <span class="cm-builtin">$customFieldsProject.getCustomField</span>(<span class="cm-builtin">$projectId</span>, <span class="cm-string">'custom_field'</span>))
    <span class="cm-keyword">#if</span> (<span class="cm-builtin">$field</span>)
        <span class="cm-builtin">$projectId</span> custom_field <span class="cm-operator">=</span> <span class="cm-builtin">$field.getValue</span>()
        <span class="cm-operator">&lt;</span>br<span class="cm-operator">&gt;</span>
        <span class="cm-keyword">#set</span>(<span class="cm-builtin">$field</span> <span class="cm-operator">=</span> false)
    <span class="cm-keyword">#end</span>
<span class="cm-keyword">#end</span>
    </code>
</pre>

<p>Get global record value:</p>
<pre>
    <code data-language="velocity">
<span class="cm-builtin">$globalRecords.getRecord</span>(<span class="cm-string">'record_name'</span>)
    </code>
</pre>

<p>Set custom field value:</p>
<pre>
    <code data-language="velocity">
<span class="cm-builtin">$customFieldsProject.setCustomField</span>(<span class="cm-string">'elibrary'</span>, <span class="cm-string">'custom_field'</span>, <span class="cm-string">'new_value'</span>)
    </code>
</pre>

<p>Set global record value:</p>
<pre>
    <code data-language="velocity">
<span class="cm-builtin">$globalRecords.setRecord</span>(<span class="cm-string">'record_name'</span>, <span class="cm-string">'record_value'</span>)
    </code>
</pre>
